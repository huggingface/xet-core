<html>

<head>
    <meta charset="UTF-8" />
    <script type="text/javascript" src="xet_meta.js"></script>
</head>

<body>
    <p>
        <label for="file_picker">Choose a file to upload with Xet:</label>
        <input type="file" id="file_picker" name="file_picker">
    </p>
    <script type="module">
        import init, { test_async_blob_reader, clean_file } from "./target/simple.js";
        await init();
        // let ret = await test_threads();
        // console.log("test_threads says: " + ret);

        document.getElementById("file_picker").addEventListener(
            "change",
            async function () {
                console.log("eventListener 'change' inside simple.html runs");

                let file = this.files[0];
                console.log("cleaning file: " + file);

                console.log("getting auth info...");

                let xetmetadata = await fetchXetMetadataFromRepoInfo({
                    tokenType: "write",
                    repoId: "[FILL THIS]",
                    repoType: "dataset",
                    headers: {
                        "Authorization": "Bearer [FILL THIS]",
                        "User-Agent": "xet-wasm"
                    },
                });

                console.log("CAS endpoint: " + xetmetadata.endpoint);
                console.log("CAS token: " + xetmetadata.accessToken);
                console.log("CAS token expiry: " + xetmetadata.expirationUnixEpoch);

                // let ret = await test_async_blob_reader(file);
                let ret = await clean_file(file, xetmetadata.endpoint, xetmetadata.accessToken, BigInt(xetmetadata.expirationUnixEpoch));
                console.log("test result: " + ret);
            },
            false
        );
    </script>
</body>

</html>