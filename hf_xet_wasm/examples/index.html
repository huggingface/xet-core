<html>

<head>
    <meta charset="UTF-8" />
    <script type="text/javascript" src="xet_meta.js"></script>
    <script type="text/javascript" src="commit.js"></script>
</head>

<body>
    <p>
        <label for="file_picker">Choose a file to upload with Xet:</label>
        <input type="file" id="file_picker" name="file_picker">
    </p>
    <div id="result"></div>
    <script type="module">
        import init, { thread_async_channel, test_async_blob_reader, clean_file } from "./target/simple.js";
        await init();

        // var ret = await thread_async_channel();
        // console.log("thread_async_channel says: " + ret);

        document.getElementById("file_picker").addEventListener(
            "change",
            async function () {
                const repo_type = "[FILL_ME]";
                const repo_id = "[FILL_ME]";
                const hf_token = "[FILL_ME]";

                const file = this.files[0];

                console.log("getting auth info...");

                const xetmetadata = await fetchXetMetadataFromRepoInfo({
                    tokenType: "write",
                    repoId: repo_id,
                    repoType: repo_type,
                    headers: {
                        "Authorization": `Bearer ${hf_token}`,
                        "User-Agent": "xet-wasm"
                    },
                });

                const file_name = file.name;
                const file_size = file.size;

                // let ret = await test_async_blob_reader(file);
                let sha256 = await clean_file(file, xetmetadata.endpoint, xetmetadata.accessToken, BigInt(xetmetadata.expirationUnixEpoch));
                console.log("result: " + sha256);

                let response = await commit(file_name, sha256, file_size, repo_type, repo_id, "main", hf_token);
                document.getElementById('result').textContent = response;
            },
            false
        );
    </script>
</body>

</html>